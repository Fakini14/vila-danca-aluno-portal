# ğŸ”„ Diagrama do Fluxo de Pagamento Asaas

## ğŸ“Š **Fluxo Visual Completo**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FLUXO DE PAGAMENTO ASAAS                          â”‚
â”‚                        (JÃ¡ Implementado)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ§‘â€ğŸ“ ALUNO                    ğŸ’» SISTEMA                    ğŸ’³ ASAAS

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Acessa  â”‚
â”‚ Portal  â”‚
â”‚ Aluno   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VÃª      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚ Lista turmas    â”‚
â”‚ Turmas  â”‚                â”‚ disponÃ­veis     â”‚
â”‚ Disp.   â”‚                â”‚ (filtradas)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                              â”‚
     v                              v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clica   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚ Valida dados    â”‚
â”‚"Assinar â”‚                â”‚ do estudante    â”‚
â”‚Mensald."â”‚                â”‚ (obrigatÃ³rios)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                              â”‚
     â”‚                              v
     â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     â”‚ Busca           â”‚â”€â”€â”€â”€>â”‚ Cliente     â”‚
     â”‚                     â”‚asaas_customer_idâ”‚     â”‚ existe?     â”‚
     â”‚                     â”‚ na tabela       â”‚     â”‚             â”‚
     â”‚                     â”‚ students        â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                              â”‚                     â”‚
     â”‚                              v               â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
     â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    SIM    â”‚
     â”‚                     â”‚ Cria matrÃ­cula  â”‚      â”‚           â”‚
     â”‚                     â”‚ (ativa: false)  â”‚      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚ em enrollments  â”‚            â”‚
     â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                              â”‚                     â”‚
     â”‚                              v                     â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚              â”‚ Chama Edge Function         â”‚       â”‚
     â”‚              â”‚ create-subscription-checkoutâ”‚       â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚                              â”‚                     â”‚
     â”‚                              v                     â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚              â”‚                             â”‚       â”‚
     â”‚              â”‚    PROCESSAMENTO ASAAS      â”‚       â”‚
     â”‚              â”‚                             â”‚       â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚                              â”‚                     â”‚
     â”‚                              v                     â”‚
     â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                     â”‚ Reutiliza       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚ cliente         â”‚
     â”‚                     â”‚ existente       â”‚
     â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                              â”‚
     â”‚                              v
     â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                â”‚              NÃƒO                         â”‚
     â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                   â”‚
     â”‚                                   v
     â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                          â”‚ Busca por CPF   â”‚
     â”‚                          â”‚ no Asaas        â”‚
     â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                   â”‚
     â”‚                                   v
     â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                          â”‚ Encontrado?     â”‚
     â”‚                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    â”‚                       â”‚
     â”‚                   SIM                     NÃƒO
     â”‚                    â”‚                       â”‚
     â”‚                    v                       v
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚ Usa cliente     â”‚    â”‚ Cria novo       â”‚
     â”‚           â”‚ encontrado      â”‚    â”‚ cliente         â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ no Asaas        â”‚
     â”‚                    â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                       â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚
     â”‚                            v
     â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                   â”‚ Salva           â”‚
     â”‚                   â”‚asaas_customer_idâ”‚
     â”‚                   â”‚ na tabela       â”‚
     â”‚                   â”‚ students        â”‚
     â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚
     â”‚                            v
     â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                   â”‚ Cria checkout   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ Gera URL    â”‚
     â”‚                   â”‚ de assinatura   â”‚           â”‚ checkout    â”‚
     â”‚                   â”‚ recorrente      â”‚           â”‚ Asaas       â”‚
     â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚                             â”‚
     â”‚                            v                             â”‚
     â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
     â”‚                   â”‚ Retorna URL do  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                   â”‚ checkout para   â”‚
     â”‚                   â”‚ frontend        â”‚
     â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â”‚
     â”‚                            v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirec.â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Redireciona     â”‚
â”‚ para    â”‚               â”‚ aluno para      â”‚
â”‚ Asaas   â”‚               â”‚ checkout Asaas  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Realiza â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ Processa        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ Envia       â”‚
â”‚ Pagam.  â”‚               â”‚ pagamento       â”‚           â”‚ webhook     â”‚
â”‚ Asaas   â”‚               â”‚                 â”‚           â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                           â”‚
     v                                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚ Retorna â”‚                                                     â”‚
â”‚ ao      â”‚                                                     â”‚
â”‚ Sistema â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
     â”‚                                                           â”‚
     v                                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚ VÃª      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Exibe pÃ¡gina    â”‚                   â”‚
â”‚ Confir. â”‚               â”‚ /checkout/      â”‚                   â”‚
â”‚Success  â”‚               â”‚ success         â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                                   â”‚                            â”‚
                                   v                            â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
                          â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ WEBHOOK ASAAS   â”‚
                          â”‚                 â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   v
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Event:          â”‚
                          â”‚ PAYMENT_CREATED â”‚
                          â”‚ â†’ Salva payment â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   v
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Event:          â”‚
                          â”‚ PAYMENT_        â”‚
                          â”‚ RECEIVED        â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   v
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Ã‰ primeiro      â”‚
                          â”‚ pagamento?      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                            â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                           SIM         NÃƒO
                            â”‚            â”‚
                            v            â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                   â”‚ ATIVA MATRÃCULA â”‚   â”‚
                   â”‚ enrollment      â”‚   â”‚
                   â”‚ .ativa = true   â”‚   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                            â”‚            â”‚
                            v            â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                   â”‚ Atualiza        â”‚   â”‚
                   â”‚ subscription    â”‚   â”‚
                   â”‚ status='active' â”‚   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                            â”‚            â”‚
                            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  v
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ MATRÃCULA       â”‚
                         â”‚ ATIVA E         â”‚
                         â”‚ FUNCIONANDO!    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ **Pontos-Chave do Fluxo**

### 1. **ValidaÃ§Ã£o Inteligente**
- Sistema verifica dados obrigatÃ³rios antes de prosseguir
- Exibe mensagens claras sobre campos faltantes
- Redireciona para perfil se necessÃ¡rio

### 2. **ReutilizaÃ§Ã£o de Clientes**
- Prioriza `asaas_customer_id` salvo na tabela
- Fallback: busca por CPF no Asaas
- Ãšltima opÃ§Ã£o: cria novo cliente

### 3. **Assinatura Recorrente**
- Checkout configurado para `MONTHLY`
- Primeira cobranÃ§a no dia da matrÃ­cula
- RenovaÃ§Ã£o automÃ¡tica todo mÃªs
- Multa e juros configurados

### 4. **AtivaÃ§Ã£o AutomÃ¡tica**
- MatrÃ­cula criada como `ativa: false`
- Webhook ativa apÃ³s primeiro pagamento
- Sistema completamente automatizado

### 5. **Tratamento de Erros**
- ValidaÃ§Ã£o em cada etapa
- Mensagens user-friendly
- Logs detalhados para debugging

## ğŸ“‹ **Estados dos Componentes**

### **StudentAvailableClasses**
```typescript
State Management:
- enrollingClass: string | null
- validatingStudent: string | null  
- validationError: string | null
```

### **Assinatura no Banco**
```typescript
Status Lifecycle:
- 'pending' â†’ Aguardando primeiro pagamento
- 'active' â†’ Pagamentos em dia
- 'overdue' â†’ Pagamento em atraso
- 'cancelled' â†’ Cancelada pelo usuÃ¡rio
```

### **MatrÃ­cula no Banco**  
```typescript
Status Lifecycle:
- ativa: false â†’ Criada, aguardando pagamento
- ativa: true â†’ Ativa apÃ³s primeiro pagamento
```

## ğŸš€ **AutomaÃ§Ãµes Implementadas**

1. **CriaÃ§Ã£o de Cliente**: Se nÃ£o existe, cria automaticamente
2. **Salvamento de ID**: `asaas_customer_id` salvo para reutilizaÃ§Ã£o
3. **AtivaÃ§Ã£o de MatrÃ­cula**: AutomÃ¡tica no primeiro pagamento
4. **RenovaÃ§Ã£o Mensal**: Assinatura renova automaticamente
5. **Tratamento de Atraso**: Status atualizado via webhook
6. **HistÃ³rico Completo**: Todos os pagamentos registrados

Este fluxo representa um sistema completo e profissional de gestÃ£o de assinaturas recorrentes, totalmente integrado com o Asaas e automatizado via webhooks.